<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Converter & Screenshot API</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    .container {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #6c757d;
      margin-bottom: 30px;
    }
    .upload-section {
      background: white;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .form-row {
      display: flex;
      gap: 10px;
      align-items: end;
      margin-bottom: 15px;
    }
    input[type="file"], input[type="url"] {
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      flex: 1;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      white-space: nowrap;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .api-section {
      background: white;
      padding: 20px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .endpoint {
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      margin: 5px 0;
      border-left: 4px solid #007bff;
    }
    .method {
      color: #28a745;
      font-weight: bold;
    }
    .method.delete {
      color: #dc3545;
    }
    .method.get {
      color: #ffc107;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }
    .result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .result.loading {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .screenshot-preview {
      max-width: 100%;
      max-height: 300px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-top: 10px;
    }
    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .option-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .option-group label {
      font-size: 12px;
      font-weight: bold;
      color: #495057;
    }
    .option-group input, .option-group select {
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PDF Converter & Screenshot API</h1>
    <p class="subtitle">Convert PDF documents to PNG images and capture form screenshots</p>
    
    <!-- PDF Upload Section -->
    <div class="upload-section">
      <h2>üîÑ Test PDF Upload</h2>
      <form action="/upload" method="post" enctype="multipart/form-data">
        <div class="form-row">
          <input type="file" name="pdf" accept=".pdf" required />
          <button type="submit">Upload & Convert PDF</button>
        </div>
      </form>
      <p><small>Maximum file size: 10MB</small></p>
    </div>

    <!-- Screenshot Section -->
    <div class="upload-section">
      <h2>üì∏ Test URL Screenshot</h2>
      <div class="form-row">
        <input type="url" id="urlInput" placeholder="https://forms.google.com/d/xyz..." required />
        <button type="button" onclick="captureScreenshot()" id="screenshotBtn">Capture Screenshot</button>
      </div>
      
      <!-- Advanced Options -->
      <details>
        <summary style="cursor: pointer; color: #007bff; font-weight: bold;">‚öôÔ∏è Advanced Options</summary>
        <div class="options">
          <div class="option-group">
            <label>Viewport Width</label>
            <input type="number" id="viewportWidth" value="1280" min="800" max="1920" />
          </div>
          <div class="option-group">
            <label>Viewport Height</label>
            <input type="number" id="viewportHeight" value="800" min="600" max="1080" />
          </div>
          <div class="option-group">
            <label>Wait Time (ms)</label>
            <input type="number" id="waitTime" value="4000" min="1000" max="10000" step="1000" />
          </div>
          <div class="option-group">
            <label>Full Page</label>
            <select id="fullPage">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>
      </details>
      
      <div id="screenshotResult" class="result"></div>
    </div>

    <!-- API Documentation -->
    <div class="api-section">
      <h2>üìã API Endpoints</h2>
      
      <h3>PDF Conversion</h3>
      <div class="endpoint">
        <span class="method">POST</span> /upload
        <br><small>Convert PDF to PNG images. Returns JSON with image URLs and metadata.</small>
      </div>
      
      <div class="endpoint">
        <span class="method delete">DELETE</span> /cleanup/:uuid
        <br><small>Clean up PDF files for a specific UUID after analysis is complete.</small>
      </div>

      <h3>Screenshot Capture</h3>
      <div class="endpoint">
        <span class="method">POST</span> /screenshot
        <br><small>Capture screenshot of a URL. Returns JSON with screenshot URL and metadata.</small>
      </div>
      
      <div class="endpoint">
        <span class="method delete">DELETE</span> /cleanup/screenshot/:urlHash
        <br><small>Clean up screenshot for a specific URL hash.</small>
      </div>

      <h3>Maintenance</h3>
      <div class="endpoint">
        <span class="method get">GET</span> /cleanup
        <br><small>Clean up all old files (PDFs: 1 hour, Screenshots: 30 minutes).</small>
      </div>
      
      <div class="endpoint">
        <span class="method get">GET</span> /health
        <br><small>Health check endpoint for monitoring service status.</small>
      </div>

      <h3>Screenshot Request Format</h3>
      <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 14px;">
POST /screenshot
Content-Type: application/json

{
  "url": "https://forms.google.com/d/xyz",
  "options": {
    "viewport": { "width": 1280, "height": 800 },
    "waitTime": 4000,
    "fullPage": true
  }
}</pre>

      <h3>Screenshot Response Format</h3>
      <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 14px;">
{
  "success": true,
  "urlHash": "abc123def456",
  "screenshot": {
    "url": "https://your-service.railway.app/screenshots/abc123def456/screenshot.png",
    "size": 245760,
    "cached": false
  },
  "metadata": {
    "finalUrl": "https://forms.google.com/d/xyz",
    "pageTitle": "Contact Form",
    "loadTime": 3245,
    "viewport": { "width": 1280, "height": 800 }
  },
  "message": "Screenshot captured successfully"
}</pre>

      <h3>Usage Notes</h3>
      <ul>
        <li><strong>PDF files</strong> are cleaned up after 1 hour automatically</li>
        <li><strong>Screenshots</strong> are cached for 30 minutes and then cleaned up</li>
        <li>Each upload/screenshot gets a unique identifier to prevent conflicts</li>
        <li>Screenshots are optimized for form analysis with smart waiting and scrolling</li>
        <li>Both services support concurrent requests from multiple users</li>
        <li>Error responses include helpful suggestions for troubleshooting</li>
      </ul>
    </div>
  </div>

  <script>
    async function captureScreenshot() {
      const urlInput = document.getElementById('urlInput');
      const resultDiv = document.getElementById('screenshotResult');
      const btn = document.getElementById('screenshotBtn');
      
      const url = urlInput.value.trim();
      if (!url) {
        showResult('error', 'Please enter a valid URL');
        return;
      }

      // Get options
      const options = {
        viewport: {
          width: parseInt(document.getElementById('viewportWidth').value),
          height: parseInt(document.getElementById('viewportHeight').value)
        },
        waitTime: parseInt(document.getElementById('waitTime').value),
        fullPage: document.getElementById('fullPage').value === 'true'
      };

      // Show loading state
      btn.disabled = true;
      btn.textContent = 'Capturing...';
      showResult('loading', 'Capturing screenshot... This may take up to 45 seconds.');

      try {
        const response = await fetch('/screenshot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, options })
        });

        const data = await response.json();

        if (data.success) {
          let message = `
            <strong>‚úÖ Success!</strong> ${data.message}<br>
            <strong>URL Hash:</strong> ${data.urlHash}<br>
            <strong>Final URL:</strong> ${data.metadata.finalUrl}<br>
            <strong>Page Title:</strong> ${data.metadata.pageTitle || 'N/A'}<br>
            <strong>Load Time:</strong> ${data.metadata.loadTime || 'N/A'}ms<br>
            <strong>Screenshot Size:</strong> ${formatBytes(data.screenshot.size)}<br>
            <strong>Cached:</strong> ${data.screenshot.cached ? 'Yes (from cache)' : 'No (newly captured)'}<br>
            <strong>Viewport:</strong> ${data.metadata.viewport?.width || 'N/A'} x ${data.metadata.viewport?.height || 'N/A'}<br><br>
            <a href="${data.screenshot.url}" target="_blank" style="color: #007bff;">üì∏ View Screenshot</a>
            <img src="${data.screenshot.url}" class="screenshot-preview" alt="Captured screenshot" />
          `;
          showResult('success', message);
        } else {
          let errorMessage = `<strong>‚ùå Error:</strong> ${data.error}<br>`;
          if (data.details) {
            errorMessage += `<strong>Details:</strong> ${data.details}<br>`;
          }
          if (data.suggestions && data.suggestions.length > 0) {
            errorMessage += `<strong>Suggestions:</strong><ul>`;
            data.suggestions.forEach(suggestion => {
              errorMessage += `<li>${suggestion}</li>`;
            });
            errorMessage += `</ul>`;
          }
          showResult('error', errorMessage);
        }
      } catch (error) {
        showResult('error', `<strong>‚ùå Network Error:</strong> ${error.message}<br>Please check if the service is running and try again.`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Capture Screenshot';
      }
    }

    function showResult(type, message) {
      const resultDiv = document.getElementById('screenshotResult');
      resultDiv.className = `result ${type}`;
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Allow Enter key to trigger screenshot
    document.getElementById('urlInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        captureScreenshot();
      }
    });

    // Auto-focus URL input
    document.getElementById('urlInput').focus();
  </script>
</body>
</html>